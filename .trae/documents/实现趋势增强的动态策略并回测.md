## 需求与规则
- 开仓与分仓保持原逻辑（动态策略、半仓止盈比例 0.5 不变）。
- 止盈（仅一次）：
  - 规则1：未止盈且 `未实现收益 >= 预测收益 + 5` → 止盈一半；已有 `take_profit_done` 防重复。
  - 规则2：未止盈且 `收盘价 < 短期趋势线 short_trend` → 止盈一半；与规则1互斥，总共只止盈一次。
- 止损：
  - 规则A：`未实现收益 <= -stop_loss`（现有逻辑）。
  - 规则B：`收盘价 < 长期多空线 long_trend` → 触发止损（全平）。
- 复利开仓：新开仓的“每槽资金”改为使用当前权益（实现收益）进行复利分配，不再固定 `初始本金/5`。

## 影响范围
- `src/backtest_engine.py`：扩展止盈/止损判定；动态复利分配开仓资金。
- 数据依赖：`get_stock_daily` 返回的日线需含 `short_trend`、`long_trend` 列（数据库已预计算）。

## 实现步骤
### 1. 扩展止盈/止损逻辑
- 修改函数 `check_stop_loss_take_profit`（src/backtest_engine.py:319-343）：
  - 新增入参或内部读取当天的 `short_trend`、`long_trend`。
  - 判定顺序：
    1) 止损：`unrealized_pnl <= self.stop_loss_pct` 或 `current_price < long_trend` → 返回 `('stop_loss', None)`。
    2) 止盈（仅一次）：`not position.take_profit_done` 且（`unrealized_pnl >= predicted + buffer` 或 `current_price < short_trend`）→ 返回 `('take_profit', 0.5)`。
  - 保持 `reason='take_profit'`，以沿用 `Position.close_partial` 中的 `take_profit_done` 逻辑（src/backtest_engine.py:85-89）。

### 2. 在回测循环中传入趋势线
- 在 `run_backtest` 的每日循环中，取当日价格时（src/backtest_engine.py:393-406）：
  - 从 `price_df.iloc[0]` 额外读取 `short_trend`、`long_trend`；若列缺失或为空则跳过相应规则。
  - 调用 `check_stop_loss_take_profit(position, current_price, current_date_str, short_trend, long_trend)`（增加参数）。

### 3. 复利开仓资金分配
- 将固定分配（src/backtest_engine.py:451）替换为基于当前权益指数的动态分配：
  - `per_slot_capital = (self.portfolio.equity_index * self.initial_capital) / self.max_positions`
  - 仍使用现金约束：`openable_by_cash = int(self.portfolio.cash // per_slot_capital)`，确保不会超配。
  - 其余开仓与分仓逻辑不变（src/backtest_engine.py:463-474）。

### 4. 输出与审计保持兼容
- 交易明细 `backtest_trades_dynamic.csv` 保持 `close_reason` 为 `take_profit` 或 `stop_loss`；
- 操作日志 `backtest_operations.csv` 保持现有结构，便于对比新增策略前后效果。

## 回测与使用
- 入口：`src/backtest.py` 动态策略无需新增 CLI 参数，沿用 `--stop-loss` 与 `--take-profit-buffer`。
- 示例：
  - `python src/backtest.py --strategy dynamic --stop-loss 5 --take-profit-buffer 5 --initial-capital 100000`
- 结果文件：
  - 成交明细：`backtest_trades_dynamic.csv`
  - 权益曲线：`backtest_equity_curve.csv`
  - 操作日志：`backtest_operations.csv`

## 验证要点
- 随机抽样检查日志中首次触发的止盈是否仅一次（`take_profit_done` 为 True 后不再重复）。
- 校验当日 `close < short_trend` 时有半仓止盈行为；`close < long_trend` 时触发全平止损。
- 对比复利前后同区间的权益曲线增速是否变化（`backtest_equity_curve.csv`）。

## 风险与处理
- 若数据库缺失 `short_trend`/`long_trend`：保留原止盈/止损逻辑并在控制台打印一次提示。
- 复利分配仅基于已实现收益（`equity_index`），不依赖浮动市值，避免过度杠杆。

确认后我将按上述步骤修改代码并运行一次端到端回测，输出结果文件供你复核。